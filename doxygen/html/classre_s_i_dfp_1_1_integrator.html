<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PIC SID Project: Integrator Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">PIC SID Project
   &#160;<span id="projectnumber">prototype</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('classre_s_i_dfp_1_1_integrator.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a>  </div>
  <div class="headertitle">
<div class="title">Integrator Class Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p><code>#include &lt;<a class="el" href="_integrator_8h_source.html">Integrator.h</a>&gt;</code></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:a4181b95875dc83b7599e73ae1a52351d"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classre_s_i_dfp_1_1_integrator.html#a4181b95875dc83b7599e73ae1a52351d">Integrator</a> (const unsigned <a class="el" href="readme__resid_8txt.html#a1cbedcc33990b77eae61c0e6ee8eaa7d">short</a> *vcr_kVg, const unsigned <a class="el" href="readme__resid_8txt.html#a1cbedcc33990b77eae61c0e6ee8eaa7d">short</a> *vcr_n_Ids_term, const unsigned <a class="el" href="readme__resid_8txt.html#a1cbedcc33990b77eae61c0e6ee8eaa7d">short</a> *opamp_rev, unsigned <a class="el" href="readme__resid_8txt.html#a1cbedcc33990b77eae61c0e6ee8eaa7d">short</a> kVddt, unsigned <a class="el" href="readme__resid_8txt.html#a1cbedcc33990b77eae61c0e6ee8eaa7d">short</a> n_snake)</td></tr>
<tr class="separator:a4181b95875dc83b7599e73ae1a52351d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afe03040292e8ee1a1692df79b2e9847e"><td class="memItemLeft" align="right" valign="top"><a class="el" href="bassmidi_8h.html#a1775701abced24e4580d5d7a69fca07a">void</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classre_s_i_dfp_1_1_integrator.html#afe03040292e8ee1a1692df79b2e9847e">setVw</a> (unsigned <a class="el" href="readme__resid_8txt.html#a1cbedcc33990b77eae61c0e6ee8eaa7d">short</a> Vw)</td></tr>
<tr class="separator:afe03040292e8ee1a1692df79b2e9847e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acd93688feb59d0aea3e888f6acd31a0f"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classre_s_i_dfp_1_1_integrator.html#acd93688feb59d0aea3e888f6acd31a0f">solve</a> (int vi)</td></tr>
<tr class="separator:acd93688feb59d0aea3e888f6acd31a0f"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Find output voltage in inverting integrator <a class="el" href="classre_s_i_dfp_1_1_s_i_d.html">SID</a> op-amp circuits, using a single fixpoint iteration step.</p>
<p>A circuit diagram of a MOS 6581 integrator is shown below. </p><pre class="fragment">               ---C---
              |       |
vi -----Rw-------[A&gt;----- vo
     |      | vx
      --Rs--
</pre><p>From Kirchoff's current law it follows that </p><pre class="fragment">IRw + IRs + ICr = 0
</pre><p>Using the formula for current through a capacitor, i = C*dv/dt, we get </p><pre class="fragment">IRw + IRs + C*(vc - vc0)/dt = 0
dt/C*(IRw + IRs) + vc - vc0 = 0
vc = vc0 - n*(IRw(vi,vx) + IRs(vi,vx))
</pre><p>which may be rewritten as the following iterative fixpoint function: </p><pre class="fragment">vc = vc0 - n*(IRw(vi,g(vc)) + IRs(vi,g(vc)))
</pre><p>To accurately calculate the currents through Rs and Rw, we need to use transistor models. Rs has a gate voltage of Vdd = 12V, and can be assumed to always be in triode mode. For Rw, the situation is rather more complex, as it turns out that this transistor will operate in both subthreshold, triode, and saturation modes.</p>
<p>The Shichman-Hodges transistor model routinely used in textbooks may be written as follows: </p><pre class="fragment">Ids = 0                          , Vgst &lt; 0               (subthreshold mode)
Ids = K/2*W/L*(2*Vgst - Vds)*Vds , Vgst &gt;= 0, Vds &lt; Vgst  (triode mode)
Ids = K/2*W/L*Vgst^2             , Vgst &gt;= 0, Vds &gt;= Vgst (saturation mode)
</pre><p>where K = u*Cox (conductance) W/L = ratio between substrate width and length Vgst = Vg - Vs - Vt (overdrive voltage)</p>
<p>This transistor model is also called the quadratic model.</p>
<p>Note that the equation for the triode mode can be reformulated as independent terms depending on Vgs and Vgd, respectively, by the following substitution: </p><pre class="fragment">Vds = Vgst - (Vgst - Vds) = Vgst - Vgdt

Ids = K*W/L*(2*Vgst - Vds)*Vds
= K*W/L*(2*Vgst - (Vgst - Vgdt)*(Vgst - Vgdt)
= K*W/L*(Vgst + Vgdt)*(Vgst - Vgdt)
= K*W/L*(Vgst^2 - Vgdt^2)
</pre><p>This turns out to be a general equation which covers both the triode and saturation modes (where the second term is 0 in saturation mode). The equation is also symmetrical, i.e. it can calculate negative currents without any change of parameters (since the terms for drain and source are identical except for the sign).</p>
<p>FIXME: Subthreshold as function of Vgs, Vgd. </p><pre class="fragment">Ids = I0*e^(Vgst/(n*VT))       , Vgst &lt; 0               (subthreshold mode)
</pre><p>The remaining problem with the textbook model is that the transition from subthreshold the triode/saturation is not continuous.</p>
<p>Realizing that the subthreshold and triode/saturation modes may both be defined by independent (and equal) terms of Vgs and Vds, respectively, the corresponding terms can be blended into (equal) continuous functions suitable for table lookup.</p>
<p>The EKV model (Enz, Krummenacher and Vittoz) essentially performs this blending using an elegant mathematical formulation: </p><pre class="fragment">Ids = Is*(if - ir)
Is = 2*u*Cox*Ut^2/k*W/L
if = ln^2(1 + e^((k*(Vg - Vt) - Vs)/(2*Ut))
ir = ln^2(1 + e^((k*(Vg - Vt) - Vd)/(2*Ut))
</pre><p>For our purposes, the EKV model preserves two important properties discussed above:</p>
<ul>
<li>It consists of two independent terms, which can be represented by the same lookup table.</li>
<li>It is symmetrical, i.e. it calculates current in both directions, facilitating a branch-free implementation.</li>
</ul>
<p>Rw in the circuit diagram above is a VCR (voltage controlled resistor), as shown in the circuit diagram below. </p><pre class="fragment">                 Vw

                 |
         Vdd     |
            |---|
           _|_   |
         --    --| Vg
        |      __|__
        |      -----  Rw
        |      |   |
vi ------------     -------- vo
</pre><p>In order to calculalate the current through the VCR, its gate voltage must be determined.</p>
<p>Assuming triode mode and applying Kirchoff's current law, we get the following equation for Vg: </p><pre class="fragment">u*Cox/2*W/L*((Vddt - Vg)^2 - (Vddt - vi)^2 + (Vddt - Vg)^2 - (Vddt - Vw)^2) = 0
2*(Vddt - Vg)^2 - (Vddt - vi)^2 - (Vddt - Vw)^2 = 0
(Vddt - Vg) = sqrt(((Vddt - vi)^2 + (Vddt - Vw)^2)/2)

Vg = Vddt - sqrt(((Vddt - vi)^2 + (Vddt - Vw)^2)/2)
</pre> 
<p class="definition">Definition at line <a class="el" href="_integrator_8h_source.html#l00153">153</a> of file <a class="el" href="_integrator_8h_source.html">Integrator.h</a>.</p>
</div><h2 class="groupheader">Constructor &amp; Destructor Documentation</h2>
<a id="a4181b95875dc83b7599e73ae1a52351d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4181b95875dc83b7599e73ae1a52351d">&#9670;&nbsp;</a></span>Integrator()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classre_s_i_dfp_1_1_integrator.html">Integrator</a> </td>
          <td>(</td>
          <td class="paramtype">const unsigned <a class="el" href="readme__resid_8txt.html#a1cbedcc33990b77eae61c0e6ee8eaa7d">short</a> *&#160;</td>
          <td class="paramname"><em>vcr_kVg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const unsigned <a class="el" href="readme__resid_8txt.html#a1cbedcc33990b77eae61c0e6ee8eaa7d">short</a> *&#160;</td>
          <td class="paramname"><em>vcr_n_Ids_term</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const unsigned <a class="el" href="readme__resid_8txt.html#a1cbedcc33990b77eae61c0e6ee8eaa7d">short</a> *&#160;</td>
          <td class="paramname"><em>opamp_rev</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned <a class="el" href="readme__resid_8txt.html#a1cbedcc33990b77eae61c0e6ee8eaa7d">short</a>&#160;</td>
          <td class="paramname"><em>kVddt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned <a class="el" href="readme__resid_8txt.html#a1cbedcc33990b77eae61c0e6ee8eaa7d">short</a>&#160;</td>
          <td class="paramname"><em>n_snake</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="_integrator_8h_source.html#l00168">168</a> of file <a class="el" href="_integrator_8h_source.html">Integrator.h</a>.</p>

</div>
</div>
<h2 class="groupheader">Member Function Documentation</h2>
<a id="afe03040292e8ee1a1692df79b2e9847e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afe03040292e8ee1a1692df79b2e9847e">&#9670;&nbsp;</a></span>setVw()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="bassmidi_8h.html#a1775701abced24e4580d5d7a69fca07a">void</a> setVw </td>
          <td>(</td>
          <td class="paramtype">unsigned <a class="el" href="readme__resid_8txt.html#a1cbedcc33990b77eae61c0e6ee8eaa7d">short</a>&#160;</td>
          <td class="paramname"><em>Vw</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="_integrator_8h_source.html#l00179">179</a> of file <a class="el" href="_integrator_8h_source.html">Integrator.h</a>.</p>

</div>
</div>
<a id="acd93688feb59d0aea3e888f6acd31a0f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acd93688feb59d0aea3e888f6acd31a0f">&#9670;&nbsp;</a></span>solve()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int solve </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>vi</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li>musictools/libsidplayfp-2.0.1/src/builders/residfp-builder/residfp/<a class="el" href="_integrator_8h_source.html">Integrator.h</a></li>
</ul>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacere_s_i_dfp.html">reSIDfp</a></li><li class="navelem"><a class="el" href="classre_s_i_dfp_1_1_integrator.html">Integrator</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
